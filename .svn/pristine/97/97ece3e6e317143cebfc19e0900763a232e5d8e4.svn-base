package com.dihuo.twodfire.retail.activity.retailmanager;

import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;

import net.simonvt.menudrawer.MenuDrawer;
import net.simonvt.menudrawer.Position;

import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.client.HttpClient;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.DefaultHttpClient;
import org.apache.http.util.EntityUtils;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.ProgressDialog;
import android.content.Context;
import android.content.Intent;
import android.os.AsyncTask;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.support.v4.view.PagerAdapter;
import android.support.v4.view.ViewPager;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.widget.AdapterView;
import android.widget.TextView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ListView;

import com.dihuo.twodfire.retail.R;
import com.dihuo.twodfire.retail.RetailApplication;
import com.dihuo.twodfire.retail.activity.BaseActivity;
import com.dihuo.twodfire.retail.activity.login.ChangeBackgroundActivity;
import com.dihuo.twodfire.retail.activity.login.LoginActivity;
import com.dihuo.twodfire.retail.activity.goodsmanager.GoodsManagerMainMenuActivity;
import com.dihuo.twodfire.retail.activity.goodsmanager.GoodsSearchActivity;
import com.dihuo.twodfire.retail.activity.login.UserInfoActivity;
import com.dihuo.twodfire.retail.activity.logisticmanager.LogisticsManagerActivity;
import com.dihuo.twodfire.retail.activity.setting.SettingActivity;
import com.dihuo.twodfire.retail.global.Constants;
import com.dihuo.twodfire.retail.netData.LoginResult;
import com.dihuo.twofire.retail.adapter.MoreInfoAdapter;
import com.dihuo.twofire.retail.adapter.MoreInfoItem;
import com.dihuo.twofire.retail.util.MD5;
import com.dihuo.twofire.retail.util.ToastUtil;
import com.dohuo.twofire.retail.network.AsyncHttpPost;
import com.dohuo.twofire.retail.network.RequestParameter;
import com.dohuo.twofire.retail.network.RequestResultCallback;
import com.dihuo.twodfire.retail.activity.stockmanager.StockManagerActivity;
import com.dihuo.twodfire.retail.common.ErrorMsg;

/**
 * 后台主页面
 * @author kyolee
 * @date 2014-9-10
 */

public class RetailBGdetailActivity extends BaseActivity{
	
	private ViewPager viewPager = null;
	private List<View> pageList = null;
	MyPagerAdapter mMyPagerAdapter = null;
	private MenuDrawer mMenu;
	private ListView mListView;
	private ArrayList<MoreInfoItem> mList;
	private MoreInfoAdapter adapter;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		// TODO Auto-generated method stub
		mMenu = MenuDrawer.attach(this,Position.RIGHT);
		mMenu.setContentView(R.layout.store_main);
		mMenu.setMenuView(R.layout.user_info);
		super.onCreate(savedInstanceState);
//		setContentView(R.layout.store_main);
		initIntroductionPage();
		initMenu();
	}

	private void initMenu() {
		mListView = (ListView)mMenu.findViewById(R.id.more_info_list);
		
		mList = new ArrayList<MoreInfoItem>();
		
		mList.add(new MoreInfoItem (R.drawable.ico_more_pw,"修改密码"));
		mList.add(new MoreInfoItem (R.drawable.ico_more_bg,"更换图片"));
		mList.add(new MoreInfoItem (R.drawable.ico_more_contact,"购物中心"));
		mList.add(new MoreInfoItem (R.drawable.ico_more_about,"关于"));		
		mList.add(new MoreInfoItem (R.drawable.ico_more_quit,"退出"));		
	
		adapter = new MoreInfoAdapter(this, mList);
		
		mListView.setAdapter(adapter);
		
		mListView.setOnItemClickListener(new OnItemClickListener() {

			@Override
			public void onItemClick(AdapterView<?> arg0, View arg1, int arg2,
					long arg3) {
				// TODO Auto-generated method stub
				Intent intent = new Intent(RetailBGdetailActivity.this,ChangeBackgroundActivity.class);
				startActivity(intent);
			}
		});
		
		((TextView)findViewById(R.id.user_info_name)).setText(RetailApplication.getmUserInfo().getName());
		((TextView)findViewById(R.id.user_title)).setText(RetailApplication.getmUserInfo().getName());
		((TextView)findViewById(R.id.user_store)).setText(RetailApplication.getmShopInfo().getShopName());
		
	}

	@Override
	protected void onDestroy() {
		// TODO Auto-generated method stub
		super.onDestroy();
	}

	private void initIntroductionPage() {
		LayoutInflater inflater = LayoutInflater.from(this);
		//初始化触摸探测
		viewPager = (ViewPager)findViewById(R.id.profit_viewflipper);
		pageList = new LinkedList<View>();
		View v1 = inflater.inflate(R.layout.profit_1, null);
		View v2 = inflater.inflate(R.layout.profit_2, null);
		View v3 = inflater.inflate(R.layout.profit_3, null);
		pageList.add(v1);
		pageList.add(v2);
		pageList.add(v3);
		mMyPagerAdapter = new MyPagerAdapter(RetailBGdetailActivity.this);
		
		if(mMyPagerAdapter!=null)
		{
			viewPager.setAdapter(mMyPagerAdapter);		
		}
	}
	
	public void ImgClickListener(View v) {
		switch (Integer.parseInt(String.valueOf(v.getTag()))) {
		case 1:// 商品管理
			startActivity(new Intent(RetailBGdetailActivity.this, GoodsManagerMainMenuActivity.class));
			break;
		case 2:// 会员管理
			//startActivity(new Intent(StoreDetail.this, MemberInfoActivity.class));
			break;
		case 3:// 物流管理
			startActivity(new Intent(RetailBGdetailActivity.this, LogisticsManagerActivity.class));
			break;
		case 4:// 库存管理
			startActivity(new Intent(RetailBGdetailActivity.this, StockManagerActivity.class));
			break;
		case 5:// 门店管理
			startActivity(new Intent(RetailBGdetailActivity.this, RetailManagerActivity.class));
			break;
		case 6:// 消息中心
			//startActivity(new Intent(StoreDetail.this, Setting.class));
		case 7:// 设置
			startActivity(new Intent(RetailBGdetailActivity.this, SettingActivity.class));
			break;
		case 8:// 营销管理
			//startActivity(new Intent(StoreDetail.this, MemberInfoActivity.class));
			break;
		case 9:// 报表中心
			//startActivity(new Intent(StoreDetail.this, Setting.class));
			break;	
		case 10:// 更多用户信息
//			startActivity(new Intent(RetailBGdetailActivity.this, UserInfoActivity.class));
			mMenu.toggleMenu();
			break;	
		case 11:// 报表中心
			//startActivity(new Intent(StoreDetail.this, Setting.class));
			break;		
		default :
			break;
		}
	}

	class MyPagerAdapter extends PagerAdapter {

		private Context ctx;
		public MyPagerAdapter(Context ctx) {
			this.ctx = ctx;
		}
		
		/* (non-Javadoc)
		 * @see android.support.v4.view.PagerAdapter#getCount()
		 */
		@Override
		public int getCount() {
			return pageList == null ? 0 : pageList.size();
		}

		/* (non-Javadoc)
		 * @see android.support.v4.view.PagerAdapter#isViewFromObject(android.view.View, java.lang.Object)
		 */
		@Override
		public boolean isViewFromObject(View arg0, Object arg1) {
			return arg0 == arg1;
		}
		
		/* (non-Javadoc)
		 * @see android.support.v4.view.PagerAdapter#getItemPosition(java.lang.Object)
		 */
		@Override
		public int getItemPosition(Object object) {
			return super.getItemPosition(object);
		}

		/* (non-Javadoc)
		 * @see android.support.v4.view.PagerAdapter#destroyItem(android.view.View, int, java.lang.Object)
		 */
		@Override
		public void destroyItem(View container, int position, Object object) {
			((ViewPager) container).removeView(pageList.get(position));
		}
		
		/* (non-Javadoc)
		 * @see android.support.v4.view.PagerAdapter#instantiateItem(android.view.View, int)
		 */
		@Override
		public Object instantiateItem(View container, int position) {
			((ViewPager)container).addView(pageList.get(position));
			return pageList.get(position);
		}
		
	}

	@Override
	protected void onResume() {
		// TODO Auto-generated method stub
		super.onResume();
		
		getProgressDialog().setCancelable(false);
		// progressDialog.setCanceledOnTouchOutside(false);
		getProgressDialog()
				.setMessage(getResources().getText(R.string.in_login));
		getProgressDialog().show();
		
		//传递请求参数
		RequestParameter parameters = new RequestParameter();
		parameters.setUrl(Constants.MAINPAGE);
		//显示今天的数据信息

    	parameters.setParam("sessionId", RetailApplication.getmSessionId());
    	parameters.setParam("version", "");
    	parameters.setParam("appKey", "");
    	parameters.setParam("timestamp", String.valueOf(System.currentTimeMillis()));
    	parameters.setParam("sign", "");
		parameters.setParam("shopId", "00000000000000000000000000000001");
		parameters.setParam("timeRange", "nowDay");


		
		AsyncHttpPost httppost = new AsyncHttpPost(parameters,
        new RequestResultCallback() {
	        @Override
	        public void onSuccess(String str) {
                Log.i("results", str);
                Message msg = new Message();
                if(Constants.isResuestSucess(str)){
                	msg.what = Constants.HANDLER_SUCESS;
                    msg.obj = str;
                }
                else{
                	msg.what = Constants.HANDLER_ERROR;
                	msg.obj = getFailMsg(str);
                }
                mLoginHandler.sendMessage(msg);
	        }
	        @Override
	        public void onFail(Exception e) {
                e.printStackTrace();
                Message msg = new Message();
                msg.what = Constants.HANDLER_FAIL;
                msg.obj = e.getMessage();
                mLoginHandler.sendMessage(msg);
	        }
        });
		httppost.execute();
	}
	
	
	/**
	 * 处理返回的结果，如果成功解析网络返回的json数据
	 */
	Handler mLoginHandler = new Handler(){
		@Override
		public void handleMessage(Message msg) {
			getProgressDialog().dismiss();
			
			switch (msg.what) {
				case Constants.HANDLER_SUCESS:										
				try {
					parserJson(msg.obj.toString());
				} catch (JSONException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
				break;
				
				case Constants.HANDLER_FAIL:
					ToastUtil.showShortToast(getApplicationContext(),
					        msg.obj.toString());
					break;
				case Constants.HANDLER_ERROR:
				ToastUtil.showShortToast(getApplicationContext(),
				        msg.obj.toString());
					break;
			}
		}
	};
	
	//解析json数据
	protected void parserJson(String result) throws JSONException {
		
	}
	
		//获取错误消息
		protected String getFailMsg(String result) {	
			
			String strErrorMsg = "";
			String strRet= "";
			int errCode = 0;
			JSONObject jobj;		
			try {
				jobj = new JSONObject(result);
				strErrorMsg = jobj.getString("exceptionCode");

			}catch (JSONException e) {
				e.printStackTrace();
				strErrorMsg ="";
			}
//			errCode = 1;
			errCode = ErrorMsg.getEorMsgId(strErrorMsg);
			
			switch (errCode) {
			
				case 1:
					strRet = getResources().getString(R.string.um_msg_000001);				
					break;
				case 2:
					strRet = getResources().getString(R.string.um_msg_000002);				
					break;
				case 3:
					strRet = getResources().getString(R.string.um_msg_000003);				
					break;
				case 4:
					strRet = getResources().getString(R.string.um_msg_000004);				
					break;
				case 5:
					strRet = getResources().getString(R.string.um_msg_000005);				
					break;	
				case 6:
					strRet = getResources().getString(R.string.um_msg_000006);				
					break;
				case 7:
					strRet = getResources().getString(R.string.um_msg_000007);				
					break;
				case 8:
					strRet = getResources().getString(R.string.um_msg_000008);				
					break;
				case 9:
					strRet = getResources().getString(R.string.um_msg_000009);				
					break;
				case 10:
					strRet = getResources().getString(R.string.um_msg_0000010);				
					break;	
				case 11:
					strRet = getResources().getString(R.string.um_msg_0000011);				
					break;
				case 12:
					strRet = getResources().getString(R.string.um_msg_0000012);				
					break;
				case 13:
					strRet = getResources().getString(R.string.um_msg_0000013);				
					break;
				case 14:
					strRet = getResources().getString(R.string.um_msg_0000014);				
					break;		
		
				default:
				break;
			}
			
			return strRet;
		}
	
}
