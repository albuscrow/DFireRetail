package com.dfire.retail.app.manage.activity.goodsmanager;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import org.json.JSONException;
import org.json.JSONObject;

import com.dfire.retail.app.manage.R;
import com.dfire.retail.app.manage.activity.goodsmanager.MyCheckBoxLayout.Listener;
import com.dfire.retail.app.manage.common.SelectDateDialog;
import com.dfire.retail.app.manage.data.GoodsVo;
import com.dfire.retail.app.manage.data.SalesSetGoodsVo;
import com.dfire.retail.app.manage.data.SalesSetVo;
import com.dfire.retail.app.manage.global.Constants;
import com.dfire.retail.app.manage.network.AsyncHttpPost;
import com.dfire.retail.app.manage.network.RequestParameter;
import com.dfire.retail.app.manage.network.RequestResultCallback;
import com.dfire.retail.app.manage.util.JsonUtil;
import com.dfire.retail.app.manage.util.ToastUtil;
import com.google.gson.Gson;

import android.app.ProgressDialog;
import android.os.Bundle;
import android.text.InputType;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.CheckBox;
import android.widget.TextView;

/**
 * The Class SaleSettingActivity.
 * 
 * @author albuscrow
 */
public class SaleSettingActivity extends GoodsManagerBaseActivity implements OnClickListener{
	
	private ArrayList<String> ids;
	private MyEditTextLayout ticheng;
	private MyEditTextLayout zhekou;
	private CheckBox jifen;
	private CheckBox youhui;
	private CheckBox tejia;
	private CheckBox huiyuan;
	private TextView begin;
	private TextView end;
	private ArrayList<GoodsVo> goods;
	private HashMap<String, GoodsVo> goodsMap;
	
	private long endMillis;
	private long startMillis;
	private SelectDateDialog mDateDialog;
	private String selectDate;

	/* (non-Javadoc)
	 * @see com.dihuo.twodfire.retail.activity.goodsmanager.GoodsManagerBaseActivity#onCreate(android.os.Bundle)
	 */
	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setWatcher(new CountWatcher(this));
		setContentView(R.layout.activity_sale_setting);
		findViewById(R.id.title_left).setOnClickListener(this);
		findViewById(R.id.title_right).setOnClickListener(this);
		
		ticheng = setEditTextContent(R.id.ticheng,Constants.GOODS_TICHENG,Constants.EMPTY_STRING,Constants.NECESSARY, InputType.TYPE_CLASS_NUMBER);

		jifen = setCheckBoxContent(R.id.jifen, Constants.GOODS_JIFEN ,false, null);
		youhui = setCheckBoxContent(R.id.youhui, Constants.GOODS_YOUHUI ,false, null);
		
		tejia = setCheckBoxContent(R.id.isOpen, Constants.IS_OPEN, true, new Listener() {
			
			@Override
			public void checkedChange(boolean isChecked) {
				if (isChecked) {
					showTejisShezhi();
				}else{
					hideTejiaShezhi();
				}
			}
		});
		zhekou = setEditTextContent(R.id.zhekou, Constants.ZHEKOU, Constants.EMPTY_STRING, Constants.NECESSARY, InputType.TYPE_CLASS_NUMBER);
		begin = setSpinerConetent(R.id.beginTime, Constants.BEGIN_TIME, Constants.CLICK_CHOOSE);;
		begin.setOnClickListener(this);
		end = setSpinerConetent(R.id.endTime, Constants.END_TIME, Constants.CLICK_CHOOSE);;
		end.setOnClickListener(this);
		huiyuan =setCheckBoxContent(R.id.huiyuanzhuanxiang, Constants.HUIYUAN, false, null);
		
		ids = (ArrayList<String>) getIntent().getSerializableExtra(Constants.GOODSIDS);
		goods = (ArrayList<GoodsVo>) getIntent().getSerializableExtra(Constants.GOODS); 
		goodsMap = new HashMap<String, GoodsVo>();
		for (GoodsVo item : goods) {
			goodsMap.put(item.getGoodsId(), item);
		}

		setTitleText(Constants.SALE_SETTING);
		switchToEditMode();
		this.mDateDialog = new SelectDateDialog(SaleSettingActivity.this,true);//时间
//		setBack();
	}
	
	/**
	 * Show tejis shezhi.
	 */
	void showTejisShezhi(){
		findViewById(R.id.zhekou).setVisibility(View.VISIBLE);;
		findViewById(R.id.beginTime).setVisibility(View.VISIBLE);;
		findViewById(R.id.endTime).setVisibility(View.VISIBLE);;
		findViewById(R.id.huiyuanzhuanxiang).setVisibility(View.VISIBLE);;
	};
	
	/**
	 * Hide tejia shezhi.
	 */
	void hideTejiaShezhi(){
		findViewById(R.id.zhekou).setVisibility(View.GONE);;
		findViewById(R.id.beginTime).setVisibility(View.GONE);;
		findViewById(R.id.endTime).setVisibility(View.GONE);;
		findViewById(R.id.huiyuanzhuanxiang).setVisibility(View.GONE);;
	}
	
	/**
	 * Sets the check box content.
	 * 
	 * @param id
	 *            the id
	 * @param label
	 *            the label
	 * @param b
	 *            the b
	 * @param listener
	 *            the listener
	 */
	private CheckBox setCheckBoxContent(int id, String label, boolean b, Listener listener) {
		MyCheckBoxLayout layout = (MyCheckBoxLayout) findViewById(id);
		layout.init(label, b);
		layout.setListener(listener);
		layout.clearSaveFlag();
		return layout.getCheckBox();
	}
	

	/**
	 * Sets the spiner conetent.
	 * 
	 * @param tongbu
	 *            the tongbu
	 * @param label
	 *            the label
	 * @param value
	 *            the value
	 */
	private TextView setSpinerConetent(int tongbu, String label, String value) {
		MySpinnerLayout layout = (MySpinnerLayout) findViewById(tongbu);
		layout.init(label, value, null);
		layout.clearSaveFlag();
		return layout.getInputText();
	}

	/**
	 * Sets the edit text content.
	 * 
	 * @param id
	 *            the id
	 * @param label
	 *            the lable
	 * @param content
	 *            the content
	 * @param hint
	 *            the hint
	 */
	private MyEditTextLayout setEditTextContent(int id, String label, String content,
			String hint, int inputType) {
		MyEditTextLayout layout = (MyEditTextLayout) findViewById(id);
		layout.init(label, content, hint, inputType);
		layout.clearSaveFlag();
		return layout;
	}

	/* (non-Javadoc)
	 * @see android.view.View.OnClickListener#onClick(android.view.View)
	 */
	@Override
	public void onClick(View v) {
		switch (v.getId()) {
		case R.id.title_left:
			finish();
			break;
		case R.id.title_right:
			save();
			break;

		case R.id.secend:
			pushDate(v);
			break;

		default:
			break;
		}
	}

	private void save() {
		RequestParameter params = new RequestParameter(true);
		params.setUrl(Constants.SAVE_SETTING_BATCH_URL);
		SalesSetVo salesSetVo = new SalesSetVo();
		String tichengStr = ticheng.getValue();
		if (tichengStr.length() == 0) {
			ToastUtil.showShortToast(this, Constants.INPUT_TICHENG);
			return;
		}
		try {
			float parseFloat = Float.parseFloat(tichengStr);
			if (parseFloat < 0 || parseFloat > 100) {
				ToastUtil.showShortToast(this, Constants.INPUT_RIGHT_TICHENG);
				return;
			}
			salesSetVo.setPercentAge(parseFloat/100);
		} catch (Exception e) {
			ToastUtil.showShortToast(this, Constants.INPUT_RIGHT_TICHENG);
			e.printStackTrace();
			return;
		}
		if (jifen.isChecked()) {
			salesSetVo.setHasDegree((short) 1);
		}else{
			salesSetVo.setHasDegree((short) 0);
		}
		if (youhui.isChecked()) {
			salesSetVo.setIsSales((short) 1);
		}else{
			salesSetVo.setIsSales((short) 0);
		}
		List<SalesSetGoodsVo> salesSetGoodsVos = new ArrayList<SalesSetGoodsVo>();
		if (tejia.isChecked()) {
			salesSetVo.setSpecialFlag("1");
			String zhekouStr = zhekou.getValue();
			if (zhekouStr.length() == 0) {
				ToastUtil.showShortToast(this, Constants.INPUT_ZHEKOU);
				return;
			}
			try {
				float parseFloat = Float.parseFloat(zhekouStr);
				if (parseFloat < 0 || parseFloat > 100) {
					ToastUtil.showShortToast(this, Constants.INPUT_RIGHT_ZHEKOU);
					return;
				}
				salesSetVo.setDiscountRate(parseFloat/100);
			} catch (Exception e) {
				ToastUtil.showShortToast(this, Constants.INPUT_RIGHT_ZHEKOU);
				e.printStackTrace();
				return;
			}
			String beginStr = begin.getText().toString();
			String endStr = end.getText().toString();
			if (startMillis == -1 || endMillis == -1 || beginStr.equals(Constants.CLICK_CHOOSE)||endStr.equals(Constants.CLICK_CHOOSE)) {
				ToastUtil.showShortToast(this, Constants.INPUT_RIGHT_TIME);
				return;
			}
			salesSetVo.setStartTime(startMillis);
			salesSetVo.setEndTime(endMillis);
			if (huiyuan.isChecked()) {
				salesSetVo.setIsMember((short)1);
			}else{
				salesSetVo.setIsMember((short)2);
			}
			for (String id : ids) {
				SalesSetGoodsVo temp = new SalesSetGoodsVo();
				GoodsVo goodsVo = goodsMap.get(id);
				temp.setGoodsId(goodsVo.getGoodsId());
				temp.setRetailPrice(Float.parseFloat(goodsVo.getPetailPrice()) * salesSetVo.getDiscountRate());
				salesSetGoodsVos.add(temp);
			}
		}else{
			salesSetVo.setSpecialFlag("0");
			for (String id : ids) {
				SalesSetGoodsVo temp = new SalesSetGoodsVo();
				GoodsVo goodsVo = goodsMap.get(id);
				temp.setGoodsId(goodsVo.getGoodsId());;
				temp.setRetailPrice(Float.parseFloat(goodsVo.getPetailPrice()));
				salesSetGoodsVos.add(temp);
			}
		}
		
		salesSetVo.setSalesSetGoodsList(salesSetGoodsVos);
		try {
			params.setParam(Constants.SALES_SETTING, new JSONObject(new Gson().toJson(salesSetVo)));
		} catch (JSONException e1) {
			e1.printStackTrace();
		}
		
		final ProgressDialog pd = ProgressDialog.show(this, null, Constants.WAIT_SAVE_SET, true, false);
		new AsyncHttpPost(params, new RequestResultCallback() {
			
			@Override
			public void onSuccess(String str) {
				pd.dismiss();
				JsonUtil ju = new JsonUtil(str);
				if (ju.isError(SaleSettingActivity.this)) {
					return;
				}
				ToastUtil.showShortToast(SaleSettingActivity.this, Constants.SALES_SAVE_SUCCESS);
				finish();
			}
			
			@Override
			public void onFail(Exception e) {
				pd.dismiss();
				ToastUtil.showUnknowError(SaleSettingActivity.this);
				e.printStackTrace();
			}
		}).execute();
		
	}
	
	
	private void pushDate(final View v){
		mDateDialog.show();
		mDateDialog.getTitle().setText("要求到货日期");
		mDateDialog.updateDays(selectDate);
		mDateDialog.getmClearDate().setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View arg0) {
				mDateDialog.dismiss();
				((TextView) v).setText(Constants.PRESS_CHOOSE);
				if (v == begin) {
					startMillis = -1;
				}
			}
			
		});
		
		mDateDialog.getConfirmButton().setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v1) {
				mDateDialog.dismiss();
				SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd mm:hh:ss");
				selectDate = mDateDialog.getCurrentData();
				((TextView)v).setText(selectDate);
				
				if (v == begin) {
					if (selectDate!=null) {
						try {
							startMillis = (sdf.parse((selectDate+" 00:00:00"))).getTime();
						} catch (ParseException e) {
							startMillis = -1;
							e.printStackTrace();
						}
					}

				}else{
					if (selectDate!=null) {
						try {
							endMillis = (sdf.parse((selectDate+" 23:59:59"))).getTime();
						} catch (ParseException e) {
							endMillis = -1;
							e.printStackTrace();
						}
					}
				}

			}
		});
		mDateDialog.getCancelButton().setOnClickListener(new OnClickListener() {
			@Override
			public void onClick(View v) {
				mDateDialog.dismiss();
			}
		});
	}

	@Override
	public void switchToBackMode() {
	}
	
}
